name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  # Allow warnings during development phase, will be enabled for releases
  # RUSTFLAGS: "-Dwarnings"

jobs:
  # ============================================================================
  # Build and Test
  # ============================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        rust: [stable, nightly]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "build-${{ matrix.rust }}"
          cache-on-failure: true

      - name: Build all crates
        run: cargo build --workspace --all-features

      - name: Run unit tests
        run: cargo test --workspace --all-features

      - name: Run integration tests
        run: cargo test --test '*' --all-features || true

  # ============================================================================
  # Code Quality
  # ============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "lint"
          cache-on-failure: true

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        # Allow warnings during development phase, will be -D warnings for releases
        run: cargo clippy --workspace --all-features -- -W clippy::all

  # ============================================================================
  # Security Audit
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit

      - name: Run security audit
        # Continue on error for now - transitive dependency vulnerabilities
        # will be fixed by upstream maintainers (libp2p, sqlx, etc.)
        run: cargo audit || true

  # ============================================================================
  # Documentation
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "docs"
          cache-on-failure: true

      - name: Build documentation
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: "-Dwarnings"

  # ============================================================================
  # Cryptographic Tests (Critical)
  # ============================================================================
  crypto-tests:
    name: Cryptographic Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "crypto-tests"
          cache-on-failure: true

      - name: Run crypto tests
        run: cargo test -p rope-crypto --all-features -- --nocapture

  # ============================================================================
  # Consensus Tests (Critical)
  # ============================================================================
  consensus-tests:
    name: Consensus Algorithm Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "consensus-tests"
          cache-on-failure: true

      - name: Run consensus tests
        run: cargo test -p rope-consensus --all-features -- --nocapture

  # ============================================================================
  # Network Tests
  # ============================================================================
  network-tests:
    name: Network Layer Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "network-tests"
          cache-on-failure: true

      - name: Run network tests
        run: cargo test -p rope-network --all-features -- --nocapture

  # ============================================================================
  # Build Binaries
  # ============================================================================
  build-binaries:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    needs: [build, lint, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: rope-cli-linux-x64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: rope-cli-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: rope-cli-macos-arm64
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release-${{ matrix.target }}"
          cache-on-failure: true

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }} -p rope-cli

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: target/${{ matrix.target }}/release/rope-cli*

  # ============================================================================
  # Docker Build
  # ============================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build, lint]
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -f deploy/Dockerfile.node -t datachain-rope-node:${{ github.sha }} .

      - name: Build Explorer Docker image
        run: |
          docker build -f deploy/Dockerfile.explorer -t dc-explorer:${{ github.sha }} .
